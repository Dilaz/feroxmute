# Config Wizard Design

## Overview

A TUI-based wizard that helps users create a configuration file with good defaults. Serves both first-time setup and per-engagement configuration needs.

## Key Decisions

- **Output location**: `~/.feroxmute/config.toml` as global defaults
- **UI**: Interactive TUI using existing ratatui framework
- **Flow**: Progressive - essentials first, optional advanced section
- **Comments**: Minimal, for non-obvious options only
- **API keys**: Stored directly in config with 0600 permissions and warning
- **Presets**: Deferred to future iteration

## Wizard Flow

1. **Welcome** - Brief intro, explain what we're creating
2. **Provider Setup** - Select provider (Anthropic/OpenAI/LiteLLM), enter API key with masked input, optional model override
3. **Default Scope** - Web/Network/Full selection
4. **Default Constraints** - Checkboxes for `passive`, `no_exploit`, `no_portscan`
5. **Advanced?** - "Configure advanced options?" Yes/No
   - If yes: rate limit, excluded paths, output preferences
6. **Review** - Show generated TOML preview
7. **Save** - Write to `~/.feroxmute/config.toml` with 0600 permissions, show success message

**Navigation:**
- `Tab` / `Shift+Tab` or arrow keys to move between fields
- `Enter` to proceed to next screen
- `Esc` to go back or cancel
- `q` to quit entirely

## File Structure

```
feroxmute-cli/src/wizard/
├── mod.rs          # Public API: run_wizard() -> Result<PathBuf>
├── state.rs        # WizardScreen enum and WizardData struct
├── screens.rs      # Individual screen renderers
└── widgets.rs      # Reusable input components (TextInput, SelectList, CheckboxGroup)
```

## State Management

### WizardScreen

```rust
pub enum WizardScreen {
    Welcome,
    Provider,
    Scope,
    Constraints,
    AdvancedPrompt,
    Advanced,      // Only visited if user says yes
    Review,
    Complete,
}
```

### WizardData

```rust
pub struct WizardData {
    // Provider
    pub provider: ProviderName,
    pub api_key: String,
    pub model: Option<String>,
    pub base_url: Option<String>,

    // Defaults
    pub scope: Scope,
    pub passive: bool,
    pub no_exploit: bool,
    pub no_portscan: bool,

    // Advanced (optional)
    pub rate_limit: Option<u32>,
    pub excluded_paths: Vec<String>,
    pub export_html: bool,
    pub export_pdf: bool,
}
```

## TUI Widgets

### TextInput
- Masked mode for secrets (shows `••••••••`)
- Cursor positioning, basic editing (backspace, delete)
- Placeholder text in dim color

### SelectList
- Arrow keys to highlight
- Enter to select
- Shows checkmark on current selection

### CheckboxGroup
- Space to toggle
- Arrow keys to move between options
- `[x]` or `[ ]` indicators

### Screen Layout

```
┌─ Feroxmute Setup ─────────────────────┐
│                                       │
│  Section Title                        │
│  Brief explanation of this step       │
│                                       │
│  > Option 1                           │
│    Option 2                           │
│    Option 3                           │
│                                       │
│  [Tab: next field] [Enter: continue]  │
│  [Esc: back]       [q: quit]          │
└───────────────────────────────────────┘
```

## Generated Config Format

```toml
# Feroxmute default configuration
# Generated by wizard on 2025-12-19
# Override per-engagement with --config or CLI flags

[provider]
name = "anthropic"
api_key = "sk-ant-api03-..."
model = "claude-sonnet-4-20250514"

[target]
# Default scope for new engagements (web, network, full)
scope = "web"

[constraints]
passive = false
no_exploit = false
no_portscan = false
# rate_limit = 10  # Uncomment to limit requests/sec

[output]
# session_dir = "~/.feroxmute/sessions"  # Default location
export_html = false
export_pdf = false
```

**Notes:**
- `[target]` has no `host` - always per-engagement via CLI
- `[auth]` section omitted - always per-engagement

## Config Loading Order

1. Check `--config path.toml` → load if provided
2. Else check `./feroxmute.toml` → load if exists (local override)
3. Else check `~/.feroxmute/config.toml` → load if exists (global defaults)
4. Else use hardcoded defaults

CLI flags override all.

## Files Changed

### New files
- `feroxmute-cli/src/wizard/mod.rs`
- `feroxmute-cli/src/wizard/state.rs`
- `feroxmute-cli/src/wizard/screens.rs`
- `feroxmute-cli/src/wizard/widgets.rs`

### Modified files
- `feroxmute-cli/src/main.rs` - Invoke wizard when `--wizard`
- `feroxmute-core/src/config.rs` - Add `api_key` to ProviderConfig, add `load_with_defaults()`, config cascade logic
- `feroxmute-core/src/providers/factory.rs` - Read API key from config OR env var

## Implementation Notes

- **Dependencies**: None new - ratatui and crossterm already present
- **File permissions**: Use `std::fs::set_permissions()` with mode `0o600` after writing (Unix); warn on Windows
- **Directory creation**: Create `~/.feroxmute/` if it doesn't exist
- **Overwrite handling**: Ask "Overwrite existing config?" if file exists
